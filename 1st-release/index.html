<html>
    <head> 
    <meta charset = "utf-8">
        <title>Meu primeiro jogo Multiplayer </title>

        <style> 
            #screen {
                border : 10px solid #CCC;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                width: 400px;
                height: 400px;
            }
        </style>
    </head>
    <body> 
        <canvas id = "screen" width = "10" height = "10" > </canvas>

        <script> 
                const screen = document.getElementById('screen')
                const context = screen.getContext('2d')
                const currentPlayerId = 'player1'
               
              
                //Factory
                function createGame()
                {

                    const state = {
                        players: {
                            'player1': {x:1, y : 1},
                            'player2': {x:5, y : 6}
                        },
                        fruits: {
                            'fruit1': {x : 3, y:1}
                        }   
                    }
                    function movePlayer(comand){
                        
                            console.log(`Moving ${comand.playerId} with ${comand.keyPressed}`)
                            const keyPressed = comand.keyPressed
                            const player = state.players[comand.playerId]

                            if(keyPressed === 'ArrowUp' && player.y -1  >= 0){
                                player.y -= 1
                                return
                            }
                             if(keyPressed === 'ArrowRight' && player.x + 1  < screen.width){
                                player.x += 1
                                return
                            }
                              if(keyPressed === 'ArrowDown' && player.y + 1  < screen.height){
                                player.y += 1
                                return
                            }
                              if(keyPressed === 'ArrowLeft' && player.x - 1  >= 0 ){
                                player.x -= 1
                                return
                            }
                    }
                    return {
                        movePlayer,
                        state
                    }
                }
                const game = createGame();
                const KeyBordListener = createKeyBordListener();
                KeyBordListener.subscrive(game.movePlayer)

               //Factory
                function createKeyBordListener(){
                    const state = {
                        observers: []
                    }

                    function subscrive(observerFunction){
                        state.observers.push(observerFunction)
                    }

                    function notifyAll(comand){
                        console.log(`Notifyng ${state.observers.length} observers `)

                        for(const observerFunction of state.observers){
                            observerFunction(comand)
                        }
                    }

                    document.addEventListener('keydown', handleKeydonw)

                    function handleKeydonw(event){

                        const keyPressed = event.key

                        const comand = {
                            playerId : 'player1',
                            keyPressed
                        }

                        notifyAll(comand)
                    }
                    return {
                        subscrive
                    }
                }

                //Render da tela
                renderScreen()
               function renderScreen(){
                   context.fillStyle = 'white'
                   context.clearRect(0, 0, 10, 10)

                    for(const playerID in game.state.players){
                        const player = game.state.players[playerID]
                        context.fillStyle = 'black'
                        context.fillRect (player.x, player.y, 1, 1)
                    }
                    for(const fruitID in game.state.fruits){
                        const fruit = game.state.fruits[fruitID]
                        context.fillStyle = 'green'
                        context.fillRect (fruit.x, fruit.y, 1, 1)
                    }

                    requestAnimationFrame(renderScreen)
                }
        </script> 
    </body>
</html>