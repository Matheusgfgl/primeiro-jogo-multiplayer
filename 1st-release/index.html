<html>
    <head> 
    <meta charset = "utf-8">
        <title>Meu primeiro jogo Multiplayer </title>

        <style> 
            #screen {
                border : 10px solid #CCC;
                image-rendering: pixelated;
                image-rendering: crisp-edges;
                width: 400px;
                height: 400px;
            }
        </style>
    </head>
    <body> 
        <canvas id = "screen" width = "10" height = "10" > </canvas>

        <script> 
                const screen = document.getElementById('screen')
                const context = screen.getContext('2d')
                const currentPlayerId = 'player1'
               
              
                //Factory
                function createGame()
                {

                    const state = {
                        players: {},
                        fruits: {}   
                    }

                    function addPlayer(comand){   
                        const playerId = comand.playerId
                        const playerX = comand.playerX
                        const playerY = comand.playerY

                        state.players[playerId] = {
                            x: playerX,
                            y: playerY
                        }
                    }

                    function removePlayer(comand){
                        const playerId = comand.playerId
                        delete state.players[playerId]
                    }

                     function addFruit(comand){   
                        const fruitId = comand.fruitId
                        const fruitX = comand.fruitX
                        const fruitY = comand.fruitY

                        state.fruits[fruitId] = {
                            x: fruitX,
                            y: fruitY
                        }
                    }
                    
                    function removeFruit(comand){
                        const fruitId = comand.fruitId
                        delete state.fruits[fruitId]
                    }

                    function movePlayer(comand)
                    {

                        console.log(`Moving ${comand.playerId} with ${comand.keyPressed}`)

                        //Object literal
                        const acceptedMoves = {
                            ArrowDown(player){
                                console.log("Moving player down")
                                  if(player.y + 1  < screen.height){
                                    player.y += 1
                                }
                            },
                              ArrowUp(player){
                                console.log("Moving player Up")
                                if(player.y -1  >= 0){
                                    player.y -= 1
                                }
                            },
                              ArrowLeft(player){
                                console.log("Moving player left")
                                   if(keyPressed === 'ArrowLeft' && player.x - 1  >= 0 ){
                                        player.x -= 1
                                    }
                            },
                              ArrowRight(player){
                                console.log("Moving player Right")
                                if(player.x + 1  < screen.width){
                                    player.x += 1
                                }
                            }
                        }
            
                            const keyPressed = comand.keyPressed
                            const playerId = comand.playerId
                            const player = state.players[comand.playerId]
                            const moveFunction = acceptedMoves[keyPressed]
                            
                            if(player && moveFunction){
                                moveFunction(player)
                                checkForFruitCollision(playerId)
                            }    
                    }
                    
                    function checkForFruitCollision(playerId){
                        const player = state.players[playerId]

                        for(const fruitId in state.fruits){
                            const fruit = state.fruits[fruitId]
                            console.log(`Cheking ${playerId} and ${fruitId}`)

                            if(fruit.x === player.x && player.y === fruit.y){
                                console.log(`Collision between ${playerId} and ${fruitId}`)
                                removeFruit({fruitId: fruitId});
                            }
                        }
                    }


                    return {
                        addPlayer,
                        removePlayer,
                        addFruit,
                        removeFruit,
                        movePlayer,
                        state
                    }
                }

                const game = createGame();
                game.addPlayer({playerId: 'player1', playerX: 1, playerY: 1});
                 game.addPlayer({playerId: 'player 2', playerX: 3, playerY: 1});

                  game.addFruit({fruitId: 'fruit 1', fruitX: 4, fruitY: 4});
                  game.addFruit({fruitId: 'fruit2', fruitX: 6, fruitY: 4});

                const KeyBordListener = createKeyBordListener();
                KeyBordListener.subscrive(game.movePlayer);

               //Factory
                function createKeyBordListener(){
                    const state = {
                        observers: []
                    }

                    function subscrive(observerFunction){
                        state.observers.push(observerFunction)
                    }

                    function notifyAll(comand){
                        console.log(`Notifyng ${state.observers.length} observers `)

                        for(const observerFunction of state.observers){
                            observerFunction(comand)
                        }
                    }

                    document.addEventListener('keydown', handleKeydonw)

                    function handleKeydonw(event){

                        const keyPressed = event.key

                        const comand = {
                            playerId : 'player1',
                            keyPressed
                        }

                        notifyAll(comand)
                    }
                    return {
                        subscrive
                    }
                }

                //Render da tela
                renderScreen()

               function renderScreen(){
                   context.fillStyle = 'white'
                   context.clearRect(0, 0, 10, 10)

                    for(const playerID in game.state.players){
                        const player = game.state.players[playerID]
                        context.fillStyle = 'black'
                        context.fillRect (player.x, player.y, 1, 1)
                    }
                    for(const fruitID in game.state.fruits){
                        const fruit = game.state.fruits[fruitID]
                        context.fillStyle = 'green'
                        context.fillRect (fruit.x, fruit.y, 1, 1)
                    }

                    requestAnimationFrame(renderScreen)
                }
        </script> 
    </body>
</html>